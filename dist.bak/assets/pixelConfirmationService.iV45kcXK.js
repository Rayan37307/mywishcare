import{p as r}from"./index.rlwCrqap.js";class c{activeCheckouts=new Map;abandonedCheckouts=[];formChangedTimer=null;abandonmentThresholdMs=300*1e3;trackCheckoutStart(e,o,t){const n=this.generateSessionId();return this.activeCheckouts.set(n,e),setTimeout(()=>{this.activeCheckouts.has(n)&&this.handleAbandonedCheckout(n,e,o,t)},this.abandonmentThresholdMs),n}trackFormChange(e,o){this.activeCheckouts.set(e,o),this.formChangedTimer&&clearTimeout(this.formChangedTimer),this.formChangedTimer=setTimeout(()=>{this.activeCheckouts.has(e)&&this.handleAbandonedCheckout(e,o,[],0)},180*1e3)}trackCheckoutComplete(e){this.activeCheckouts.delete(e),this.formChangedTimer&&(clearTimeout(this.formChangedTimer),this.formChangedTimer=null)}handleAbandonedCheckout(e,o,t,n){this.activeCheckouts.delete(e);const s={formData:o,cartItems:t.map(i=>({product_id:i.product.id,quantity:i.quantity,price:parseFloat(i.product.price.replace(/[^\\d.-]/g,"")),name:i.product.name})),value:n,currency:"INR",timestamp:Date.now(),sessionId:e,userAgent:navigator.userAgent,ip:void 0};this.abandonedCheckouts.push(s),this.saveAbandonedCheckouts(),this.attemptCheckoutRecovery(s)}attemptCheckoutRecovery(e){console.log("Checkout abandoned, considering recovery options",{orderId:e.sessionId})}getAbandonedCheckouts(){return this.abandonedCheckouts}saveAbandonedCheckouts(){try{localStorage.setItem("abandonedCheckouts",JSON.stringify(this.abandonedCheckouts))}catch(e){console.error("Failed to save abandoned checkouts to localStorage",e)}}loadAbandonedCheckouts(){try{const e=localStorage.getItem("abandonedCheckouts");if(e){this.abandonedCheckouts=JSON.parse(e);const o=Date.now()-10080*60*1e3;this.abandonedCheckouts=this.abandonedCheckouts.filter(t=>t.timestamp>o)}}catch(e){console.error("Failed to load abandoned checkouts from localStorage",e),this.abandonedCheckouts=[]}}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}clearOldData(e=10080*60*1e3){const o=Date.now()-e;this.abandonedCheckouts=this.abandonedCheckouts.filter(t=>t.timestamp>o),this.saveAbandonedCheckouts()}initialize(){this.loadAbandonedCheckouts()}getAbandonmentStats(){return{totalAbandoned:this.abandonedCheckouts.length,recoveryRate:0,topAbandonmentPoints:["delivery_info","payment_info"]}}}const d=new c;d.initialize();class h{orderConfirmations=new Map;pendingConfirmations=new Set;constructor(){this.startVerificationScheduler()}trackOrder(e,o=["Meta","Google","TikTok"]){this.pendingConfirmations.add(e.orderId);const t={orderId:e.orderId,confirmedByPixel:!1,pixelProviders:[],timestamp:Date.now(),status:"pending"};this.orderConfirmations.set(e.orderId,t),this.sendPurchaseEvent(e,o),this.saveConfirmations()}sendPurchaseEvent(e,o){const t={value:e.value,currency:e.currency,contents:e.contents,order_id:e.orderId};o.forEach(n=>{switch(n.toLowerCase()){case"meta":case"facebook":this.sendToMetaPixel(t,e.orderId);break;case"google":this.sendToGoogleAnalytics(t,e.orderId);break;case"tiktok":this.sendToTikTokPixel(t,e.orderId);break;default:console.warn(`Unknown pixel provider: ${n}`)}})}sendToMetaPixel(e,o){r.trackPurchase(e)}sendToGoogleAnalytics(e,o){r.trackPurchase(e),typeof window.gtag<"u"&&window.gtag("event","purchase",{transaction_id:o,value:e.value,currency:e.currency,items:e.contents.map(t=>({item_id:t.id,quantity:t.quantity,item_price:t.item_price}))})}sendToTikTokPixel(e,o){r.trackPurchase(e),typeof window.ttq<"u"&&window.ttq.track("Purchase",{contents:e.contents,value:e.value,currency:e.currency})}verifyOrderConfirmation(e){const o=this.orderConfirmations.get(e);if(!o){const t={orderId:e,confirmedByPixel:!1,pixelProviders:[],timestamp:Date.now(),status:"pending"};return this.orderConfirmations.set(e,t),this.saveConfirmations(),t}return o}confirmOrder(e,o){let t=this.orderConfirmations.get(e);t||(t={orderId:e,confirmedByPixel:!1,pixelProviders:[],timestamp:Date.now(),status:"pending"}),t.pixelProviders.includes(o)||(t.pixelProviders.push(o),t.pixelProviders.length>0&&(t.confirmedByPixel=!0,t.status="verified")),this.orderConfirmations.set(e,t),this.pendingConfirmations.delete(e),this.saveConfirmations()}getConfirmedOrders(){return Array.from(this.orderConfirmations.values()).filter(e=>e.confirmedByPixel)}getPendingConfirmations(){return Array.from(this.orderConfirmations.values()).filter(e=>e.status==="pending")}getVerificationStats(){const e=Array.from(this.orderConfirmations.values()),o=e.filter(t=>t.confirmedByPixel).length;return{totalOrders:e.length,confirmedOrders:o,pendingOrders:e.length-o,confirmationRate:e.length>0?o/e.length:0}}startVerificationScheduler(){setInterval(()=>{this.checkForNewConfirmations()},300*1e3)}checkForNewConfirmations(){console.log("Checking for new pixel confirmations...")}saveConfirmations(){try{const e=Array.from(this.orderConfirmations.entries());localStorage.setItem("pixelConfirmations",JSON.stringify(e))}catch(e){console.error("Failed to save pixel confirmations",e)}}loadConfirmations(){try{const e=localStorage.getItem("pixelConfirmations");e&&JSON.parse(e).forEach(([t,n])=>{this.orderConfirmations.set(t,n),n.status==="pending"&&this.pendingConfirmations.add(t)})}catch(e){console.error("Failed to load pixel confirmations",e)}}clearOldData(e=720*60*60*1e3){const o=Date.now()-e;for(const[t,n]of this.orderConfirmations.entries())n.timestamp<o&&(this.orderConfirmations.delete(t),this.pendingConfirmations.delete(t));this.saveConfirmations()}}const l=new h;l.loadConfirmations();export{d as c,l as p};
